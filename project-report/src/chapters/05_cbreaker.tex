\chapter{Circuit Breaker}\label{ch:circuit-breaker}

This chapter describes the circuit breaker mechanism, its functionality, available configuration and how it was implemented in both the library and as a plugin for the Ktor framework integration.


\section{Introduction}\label{sec:cbreaker-introduction}

The circuit breaker mechanism is a \textit{\enquote{resilience pattern
that prevents an application from performing an operation that is likely to fail.
By allowing it
to continue
without waiting for the fault to be fixed or wasting CPU cycles while it determines that the fault is long-lasting
}}~\cite{microsoft-cbreaker-pattern}.

When an application calls a remote service, there's always a risk of failure
(e.g., network issues, service unavailability, or timeouts).
Some of these faults are temporary (transient) and resolve quickly,
but others can be long-lasting and severe (e.g., a complete loss of connectivity, complete failure of a service).

Moreover, if a service is under heavy-load, a failure in one part of the system might lead to cascading failures.
For example, if an operation is set to time out and fail after a certain period, multiple concurrent requests could be blocked until the timeout expires.
These blocked requests consume critical resources like memory, threads, and database connections, potentially leading to system-wide failures~\cite{microsoft-cbreaker-pattern}.
In such cases, itâ€™s more efficient for the application to quickly acknowledge the failure and handle it appropriately, rather than repeatedly retrying the operation.

\subsection{Relation to Retry Mechanism}\label{subsec:cbreaker-relation-to-retry}

The circuit breaker mechanism is related to the retry mechanism, as both are used to handle faults that might occur when connecting to a remote service or resource.
However, the two mechanisms are used in different situations.

The retry mechanism is used to retry an operation in the expectation that it'll succeed, while the circuit breaker mechanism is used to prevent an application from performing an operation that is likely to fail~\cite{microsoft-cbreaker-pattern}.

An application can combine these two mechanisms by using the retry mechanism to invoke an operation through a circuit breaker.
However,
the retry logic should be sensitive to any failures returned by the circuit breaker
and abandon retry attempts
if the circuit breaker indicates that a failure is not transient~\cite{microsoft-cbreaker-pattern}.

\subsection{State Machine}\label{subsec:cbreaker-state-machine}

The circuit breaker mechanism works as an electrical circuit breaker,
which is a safety device that automatically stops the flow of electric current in a circuit as a safety measure
(e.g., to prevent a fire) when it detects a fault condition.
In contrast to the electrical circuit breaker which needs to a manual reset, the circuit breaker mechanism automatically resets itself after a predefined period of time.

The default implementation of the circuit breaker uses a state machine with three states:

\begin{itemize}
    \item \textbf{Closed} - The circuit allows the operation to execute and records its execution result
    (i.e., success or failure).
    If a configurable failure threshold is reached, the circuit transitions to the open state;
    \item \textbf{Open} - The circuit does not allow the operation to be executed.
    Instead, a predefined failure message is returned.
    The circuit remains open for a predefined period of time, after which it transitions to the half-open state.
    This timer is used to allow the system to recover from the fault condition;
    \item \textbf{Half-Open} - The circuit allows a limited number of requests to execute the operation.
    If these requests are successful,
    it's assumed that the fault
    that was previously causing the failure has been fixed and the circuit breaker switches to the \texttt{Closed} state
    (resetting the failure counter).
    If any request fails,
    the circuit breaker assumes that the fault is still present,
    so it reverts to the \texttt{Open} state (restarting the timeout timer).
\end{itemize}

The \texttt{Half-Open} state is useful to prevent a recovering service from suddenly being flooded with requests. As a service recovers, it might be able to support a limited volume of requests until the recovery is complete, but while recovery is in progress a flood of work can cause the service to time out or fail again~\cite{microsoft-cbreaker-pattern}.

Other implementations might have additional states (e.g., for maintenance, testing, metrics purposes), usually manually triggered, such as:

\begin{itemize}
    \item \textbf{Forced Open} - The circuit is always open, preventing the operation from executing;
    \item \textbf{Forced Closed} - The circuit is always closed, allowing the operation to execute as if the circuit breaker were not present.
\end{itemize}

\subsection{Operation Execution}\label{subsec:cbreaker-operation-execution}

Regarding the underlying operation execution,
it's important to note that the circuit breaker does not synchronize the received calls (i.e., it does not prevent multiple threads from invoking the operation concurrently when the circuit is in a state that allows the operation to be executed).

To restrict the number of concurrent calls to the operation, a bulkhead~\cite{microsoft-bulkhead-pattern} should be used in combination with the circuit breaker.

\subsection{Recording Execution Results}\label{subsec:cbreaker-recording-execution-results}

The circuit breaker mechanism records the results of the operation executions to determine when to open the circuit.
This recording uses a sliding window~\cite{sliding-window} which can be implemented in different ways:

\begin{itemize}
    \item \textbf{Count-based} -
    The circuit breaker opens when the number of failures exceeds a predefined threshold
    (e.g., 50\% of the last 10 operations failed, assuming a window size of 10).
    \item \textbf{Time-based} -
    The circuit breaker opens when the failure rate exceeds a predefined threshold over a specific period of time
    (e.g., 50\% of the operations failed within the last 10 seconds,
    assuming a window size of 10 with one-second intervals).
\end{itemize}

The time-based sliding window is used
to track the outcomes of recent operation executions over a specific time interval,
making decisions based on recent performance rather than solely relying on historical data
(which might not be relevant in some cases).

As newer results are recorded, older results are removed from the window, keeping a FIFO (First In, First Out) ordering.
This approach ensures that the window size remains constant and that the circuit breaker can make decisions based on the most recent data.


\section{Configuration}\label{sec:cbreaker-configuration}

- mention default values and why they were chosen


\section{Implementation Aspects}\label{sec:cbreaker-implementation-aspects}


\section{Ktor Integration}\label{sec:cbreaker-ktor-integration}
